// ROMHub - Main JavaScript
console.log('ROMHub initializing...');

// Emscripten Module Configuration
// This must be defined BEFORE n64wasm.js is loaded
window.Module = {
    preRun: [],
    postRun: [],
    print: (text) => console.log('[Emulator Output] ' + text),
    printErr: (text) => console.error('[Emulator Error] ' + text),
    canvas: (function() {
        var canvas = document.getElementById('emulator-canvas');
        if (canvas) {
            canvas.addEventListener("webglcontextlost", function(e) {
                console.error('WebGL context lost. Reload required.');
                e.preventDefault();
            }, false);
        }
        return canvas;
    })(),
    onRuntimeInitialized: function() {
        console.log('N64Wasm Core Runtime Initialized');
        if (window.ROMHub) {
            window.ROMHub.advanceToPhase(1);
        }
    },
    // Required by N64Wasm to locate the .wasm file
    locateFile: function(path, prefix) {
        if (path.endsWith('.wasm')) {
            return 'assets/emulator/' + path;
        }
        return prefix + path;
    }
};

const ROMHub = {
    // Project state
    state: {
        phase: 0,
        emulatorReady: false,
        romLoaded: false,
        currentRom: null,
        saveStates: {}
    },
    
    // DOM Elements
    elements: {},
    
    // Initialize
    init() {
        console.log('Initializing ROMHub...');
        this.cacheElements();
        this.bindEvents();
        this.updateUI();
        
        // Check for existing saves
        this.loadSaveStates();
        
        // Phase 0: Waiting for emulator initialization
        this.showStatus('Phase 0: Initializing N64Wasm core...');
        
        // If the module initialized before main.js (though unlikely with proper script order)
        if (window.Module && window.Module.calledRun) {
            this.advanceToPhase(1);
        }
    },
    
    // Cache DOM elements
    cacheElements() {
        this.elements = {
            phaseIndicator: document.getElementById('phase-indicator'),
            uploadSection: document.getElementById('upload-section'),
            emulatorContainer: document.getElementById('emulator-container'),
            controls: document.getElementById('controls'),
            romFile: document.getElementById('rom-file'),
            loadRomBtn: document.getElementById('load-rom'),
            emulatorCanvas: document.getElementById('emulator-canvas'),
            saveStateBtn: document.getElementById('save-state'),
            loadStateBtn: document.getElementById('load-state'),
            resetBtn: document.getElementById('reset'),
            status: document.getElementById('status')
        };
    },
    
    // Bind event listeners
    bindEvents() {
        if (this.elements.loadRomBtn) {
            this.elements.loadRomBtn.addEventListener('click', () => this.loadROM());
        }
        
        if (this.elements.saveStateBtn) {
            this.elements.saveStateBtn.addEventListener('click', () => this.saveState());
        }
        
        if (this.elements.loadStateBtn) {
            this.elements.loadStateBtn.addEventListener('click', () => this.loadState());
        }
        
        if (this.elements.resetBtn) {
            this.elements.resetBtn.addEventListener('click', () => this.resetEmulator());
        }
    },
    
    // Update UI based on state
    updateUI() {
        const { phase, emulatorReady, romLoaded } = this.state;
        
        // Show/hide sections based on phase
        this.elements.phaseIndicator.textContent = `PHASE ${phase}: ${
            phase === 0 ? 'Core initialization...' :
            phase === 1 ? 'Core integrated. Ready for ROM.' :
            'Running'
        }`;
        
        // Show upload section when emulator is ready
        this.elements.uploadSection.classList.toggle('hidden', !emulatorReady);
        
        // Show emulator when ROM is loaded
        this.elements.emulatorContainer.classList.toggle('hidden', !romLoaded);
        this.elements.controls.classList.toggle('hidden', !romLoaded);
    },
    
    // Load ROM from file input
    async loadROM() {
        const file = this.elements.romFile.files[0];
        if (!file) {
            this.showStatus('Please select a ROM file first', 'error');
            return;
        }
        
        if (!this.state.emulatorReady) {
            this.showStatus('Emulator core is not ready yet', 'error');
            return;
        }
        
        this.showStatus(`Loading ${file.name}...`);
        
        try {
            // Read file as ArrayBuffer
            const arrayBuffer = await this.readFileAsArrayBuffer(file);
            
            // Bridge to N64Wasm FS
            // Note: N64Wasm uses a global 'FS' object provided by Emscripten
            const data = new Uint8Array(arrayBuffer);
            const romPath = 'custom.v64'; // Standard filename used by N64Wasm
            
            console.log('Writing ROM to virtual FS:', romPath);
            if (typeof FS !== 'undefined') {
                FS.writeFile(romPath, data);
            } else if (Module.FS) {
                Module.FS.writeFile(romPath, data);
            } else {
                throw new Error('Emscripten FileSystem (FS) not found');
            }
            
            // Trigger emulator load
            // N64Wasm entry point is Module.callMain
            console.log('Canvas element set in Module:', Module.canvas);
            console.log('Canvas in DOM?', document.getElementById('emulator-canvas'));
            console.log('Starting emulator via Module.callMain...');
            if (typeof Module.callMain === 'function') {
                // Make the canvas visible so the emulator can attach event listeners
                this.elements.emulatorContainer.classList.remove('hidden');
                Module.callMain([romPath]);
            } else {
                throw new Error('Emulator entry point (Module.callMain) not found');
            }
            
            // Update state
            this.state.romLoaded = true;
            this.state.currentRom = {
                name: file.name,
                size: arrayBuffer.byteLength,
                data: arrayBuffer,
                hash: await this.hashArrayBuffer(arrayBuffer)
            };
            
            this.state.phase = 2; // Advanced to running state
            this.updateUI();
            this.showStatus(`ROM loaded and running: ${file.name}`);
            
        } catch (error) {
            console.error('Failed to load ROM:', error);
            this.showStatus('Failed to load ROM: ' + error.message, 'error');
        }
    },
    
    // Read file as ArrayBuffer
    readFileAsArrayBuffer(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => reject(reader.error);
            reader.readAsArrayBuffer(file);
        });
    },
    
    // Simple hash for identifying ROMs
    async hashArrayBuffer(buffer) {
        // Simple hash for now - can be improved
        const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 16);
    },
    
    // Save state
    saveState() {
        this.showStatus('Save state functionality not yet implemented');
        // TODO: Call N64Wasm save function and store in IndexedDB
    },
    
    // Load state
    loadState() {
        this.showStatus('Load state functionality not yet implemented');
        // TODO: Load from IndexedDB and call N64Wasm load function
    },
    
    // Reset emulator
    resetEmulator() {
        this.showStatus('Reset functionality not yet implemented');
        // TODO: Reset N64Wasm emulator
    },
    
    // Load save states from IndexedDB
    async loadSaveStates() {
        // TODO: Implement IndexedDB loading
        console.log('Save state loading not yet implemented');
    },
    
    // Show status message
    showStatus(message, type = 'info') {
        if (this.elements.status) {
            this.elements.status.textContent = message;
            this.elements.status.className = `status-${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // Auto-clear after 5 seconds
        setTimeout(() => {
            if (this.elements.status && this.elements.status.textContent === message) {
                this.elements.status.textContent = '';
            }
        }, 5000);
    },
    
    // Advance to next phase (called when emulator is verified)
    advanceToPhase(phase) {
        this.state.phase = phase;
        if (phase >= 1) {
            this.state.emulatorReady = true;
        }
        this.updateUI();
        this.showStatus(`Advanced to Phase ${phase}`);
    }
};

// Initialize on DOM load
document.addEventListener('DOMContentLoaded', () => ROMHub.init());

// Make available globally for debugging
window.ROMHub = ROMHub;
